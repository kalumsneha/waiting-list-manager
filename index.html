<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DBN Waiting List Manager</title>
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
h2{text-align:center}
.controls,.limit-controls{max-width:900px;margin:15px auto;display:flex;gap:10px}
input,select{flex:1;padding:10px;border-radius:6px;border:1px solid #ccc}
button{padding:10px 15px;border-radius:6px;border:none;cursor:pointer;background:#1976d2;color:white;font-weight:bold}
button:hover{background:#125aa0}
.container{display:flex;gap:20px;max-width:900px;margin:auto}
.panel{flex:1;background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.panel h3{text-align:center;margin-top:0}
.list{min-height:300px;border:2px dashed #ccc;border-radius:8px;padding:10px}
.item{display:flex;justify-content:space-between;align-items:center;background:#e3f2fd;margin:6px 0;padding:8px 10px;border-radius:6px}
.item.incourt{background:#c8e6c9}
.arrow{cursor:pointer;font-size:18px;user-select:none;padding-left:10px}
.disabled{opacity:.4;pointer-events:none}
.stats{font-size:12px;opacity:.7;margin-left:6px}
.actions{display:flex;align-items:center;gap:6px}
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #f44336; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; }
.toast.show { opacity: 1; }
</style>
</head>
<body>

<h2>üè∏ FIFO Waiting List Manager</h2>

<div class="limit-controls">
<input type="number" id="maxInCourt" placeholder="Max in-court players" min="1" />
<button onclick="setLimit()">Set Limit</button>
</div>

<div class="controls">
<select id="playerSelect" multiple></select>
<input type="text" id="nameInput" placeholder="Enter new names (comma separated)" />
<button onclick="addSelectedOrNewPlayers()">Add Players</button>
<button onclick="clearCourt()">Clear Court</button>
</div>

<div class="container">
<div class="panel">
<h3>‚è≥ Waiting List (FIFO)</h3>
<div id="waitingList" class="list"></div>
</div>

<div class="panel">
<h3>üèüÔ∏è In-Court List</h3>
<div id="inCourtList" class="list"></div>
</div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
const firebaseConfig = window.FIREBASE_CONFIG;
if (!firebaseConfig) console.error("Firebase config is missing!");
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stateRef = db.ref("fifoState");
</script>

<script>
let state = {
  waiting: [],
  incourt: [],
  maxInCourt: null,
  stats: {}
};

function normalizeState(s){
  return {
    waiting: Array.isArray(s.waiting) ? s.waiting : [],
    incourt: Array.isArray(s.incourt) ? s.incourt : [],
    maxInCourt: (s.maxInCourt === undefined ? null : s.maxInCourt),
    stats: (typeof s.stats === 'object' && s.stats !== null ? s.stats : {})
  };
}

let initialized = false;

/* ---- Initial load ---- */
stateRef.once("value").then(snap=>{
  if(snap.exists()) state = normalizeState(snap.val());
  else stateRef.set(state);

  initialized = true;
  updatePlayerSelect();
  render();
});

/* ---- Realtime sync ---- */
stateRef.on("value", snap=>{
  if(!initialized) return;
  if(snap.exists()){
    state = normalizeState(snap.val());
    updatePlayerSelect();
    render();
  }
});

/* ---- Save ---- */
function save(){
  stateRef.set(state).then(()=>{
    console.log("‚úÖ Firebase saved");
    updatePlayerSelect();
  }).catch(e=>console.error("‚ùå Firebase error:", e));
}

/* ---- UI Logic ---- */
function setLimit(){
  const val = parseInt(document.getElementById('maxInCourt').value);
  if(!isNaN(val) && val>0){
    state.maxInCourt = val;
    save();
  }
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

function updatePlayerSelect(){
  const select = document.getElementById('playerSelect');
  select.innerHTML = '';
  Object.keys(state.stats).forEach(name=>{
    const option = document.createElement('option');
    option.value = name;
    option.innerText = name;
    select.appendChild(option);
  });
}

function addSelectedOrNewPlayers(){
  const select = document.getElementById('playerSelect');
  const selected = Array.from(select.selectedOptions).map(opt => opt.value);

  const input = document.getElementById('nameInput');
  const rawNames = input.value.split(',').map(n=>n.trim()).filter(n=>n.length>0);

  const allNames = [...new Set([...selected,...rawNames])];

  allNames.forEach(n=>{
    const inWaiting = state.waiting.includes(n);
    const inCourt = state.incourt.some(p=>p.name===n);
    if(inWaiting || inCourt){ showToast(`${n} already exists`); return; }

    state.waiting.push(n);
    if(!state.stats[n]) state.stats[n] = 0;
  });

  input.value='';
  save();
  render();
  showToast(`${allNames.length} players processed`);
}

function clearCourt(){
  const allPlayers = [...state.waiting,...state.incourt.map(p=>p.name)];
  state.waiting = [];
  state.incourt = [];
  Object.keys(state.stats).forEach(name => state.stats[name]=0);

  save();
  render();
  showToast(`Cleared ${allPlayers.length} players and reset stats`);
}

function render(){
  const waitingDiv = document.getElementById('waitingList');
  const incourtDiv = document.getElementById('inCourtList');

  waitingDiv.innerHTML='';
  incourtDiv.innerHTML='';

  state.waiting.forEach((name,i)=>{
    const div=document.createElement('div');
    div.className='item';

    const arrow=document.createElement('span');
    arrow.className='arrow';
    arrow.innerHTML='‚û°Ô∏è';

    if(i!==0 || (state.maxInCourt!==null && state.incourt.length>=state.maxInCourt)){
      arrow.classList.add('disabled');
    }

    arrow.onclick=()=>moveToInCourt(i);

    const games=state.stats[name]||0;
    div.innerHTML=`<span>${name}<span class="stats">(games: ${games})</span></span>`;
    div.appendChild(arrow);
    waitingDiv.appendChild(div);
  });

  state.incourt.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='item incourt';

    const actions=document.createElement('div');
    actions.className='actions';

    const stay=document.createElement('span');
    stay.className='arrow';
    stay.innerHTML='üîÑ';
    if(p.extraUsed) stay.classList.add('disabled');
    stay.onclick=()=>stayOneMore(i);

    const back=document.createElement('span');
    back.className='arrow';
    back.innerHTML='‚¨ÖÔ∏è';
    back.onclick=()=>moveToWaiting(i);

    actions.appendChild(stay);
    actions.appendChild(back);

    div.innerHTML=`<span>${p.name}</span>`;
    div.appendChild(actions);
    incourtDiv.appendChild(div);
  });
}

function addToWaitingList(){ addSelectedOrNewPlayers(); }

function moveToInCourt(index){
  if(index!==0) return;
  if(state.maxInCourt!==null && state.incourt.length>=state.maxInCourt) return;

  const name=state.waiting.shift();
  state.stats[name]=(state.stats[name]||0)+1;
  state.incourt.push({name:name,extraUsed:false});
  save();
}

function stayOneMore(i){
  const p=state.incourt[i];
  if(p.extraUsed) return;

  p.extraUsed=true;
  state.stats[p.name]=(state.stats[p.name]||0)+1;
  save();
}

function moveToWaiting(i){
  const p=state.incourt.splice(i,1)[0];
  state.waiting.push(p.name);
  save();
}
</script>

</body>
</html>
