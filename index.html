<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DBN Waiting List Manager</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
h2{text-align:center}
.controls,.limit-controls{max-width:900px;margin:15px auto;display:flex;gap:10px}
input,select{flex:1;padding:10px;border-radius:6px;border:1px solid #ccc}
button{padding:10px 15px;border-radius:6px;border:none;cursor:pointer;background:#1976d2;color:white;font-weight:bold}
button:hover{background:#125aa0}
.container{display:flex;gap:20px;max-width:900px;margin:auto}
.panel{flex:1;background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.panel h3{text-align:center;margin-top:0}
.list{min-height:300px;border:2px dashed #ccc;border-radius:8px;padding:10px}
/*.item{display:flex;justify-content:space-between;align-items:center;background:#e3f2fd;margin:6px 0;padding:8px 10px;border-radius:6px}
.item.incourt{background:#c8e6c9}*/
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#e3f2fd;
  margin:10px 0;
  padding:14px 16px;
  border-radius:8px;
  font-size:20px; /* larger for readability */
  font-weight:600;
  color:#0d1b2a;
}
.item.incourt{background:#c8e6c9}
.item span.stats{
  font-size:16px;
  font-weight:500;
  margin-left:12px;
  opacity:.8;
  color:#37474f;
}
/*.arrow{cursor:pointer;font-size:18px;user-select:none;padding-left:10px}*/
/*.disabled{opacity:.4;pointer-events:none}*/
.stats{font-size:12px;opacity:.7;margin-left:6px}
/*.actions{display:flex;align-items:center;gap:6px}*/
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #f44336; color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; }
.toast.show { opacity: 1; }
  /* ===== TOUCH FRIENDLY ICON BUTTONS ===== */

.icon-btn{
  width:64px;
  height:64px;
  min-width:64px;
  min-height:64px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px; /* bigger icons */
  cursor:pointer;
  user-select:none;
  transition:all .15s ease;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
  margin-left:12px;
}

.icon-btn .material-icons {
  font-size: 32px; /* same as button font-size */
  line-height: 1;
}

/* move to court */
.btn-move{background:#4caf50;color:white}
.btn-move:hover{background:#1565c0;transform:scale(1.05)}
.btn-move:active{transform:scale(.9)}

/* stay button */
.btn-stay{background:#ff9800;color:white}
.btn-stay:hover{background:#fb8c00;transform:scale(1.05)}
.btn-stay:active{transform:scale(.9)}

/* move back */
.btn-back{background:#f44336;color:white}
.btn-back:hover{background:#1b5e20;transform:scale(1.05)}
.btn-back:active{transform:scale(.9)}

/* disabled */
.icon-disabled{
  background:#bdbdbd !important;
  color:#666 !important;
  cursor:not-allowed;
  opacity:.5;
  box-shadow:none;
  transform:none !important;
  pointer-events:none;
}

/* layout */
.actions{
  display:flex;
  align-items:center;
  gap:14px;
}

/* mobile boost */
@media (max-width:768px){
  .item{font-size:18px;padding:12px 14px;}
  .item span.stats{font-size:14px;margin-left:10px;}
  .icon-btn{width:60px;height:60px;font-size:28px;}
}

</style>
</head>
<body>

<h2>üè∏ DBN Waiting List Manager</h2>

<div class="limit-controls">
<input type="number" id="maxInCourt" placeholder="Max in-court players" min="1" />
<button onclick="setLimit()">Set Limit</button>
</div>

<div class="controls">
<select id="playerSelect" multiple></select>
<input type="text" id="nameInput" placeholder="Enter new names (comma separated)" />
<button onclick="addSelectedOrNewPlayers()">Add Players</button>
<button onclick="clearCourt()">Clear Court</button>
</div>

<div class="container">
<div class="panel">
<h3>‚è≥ Waiting List (FIFO)</h3>
<div id="waitingList" class="list"></div>
</div>

<div class="panel">
<h3>üèüÔ∏è In-Court List</h3>
<div id="inCourtList" class="list"></div>
</div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
const firebaseConfig = window.FIREBASE_CONFIG;
if (!firebaseConfig) console.error("Firebase config is missing!");
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const stateRef = db.ref("fifoState");
</script>

<script>
let state = {
  waiting: [],
  incourt: [],
  maxInCourt: null,
  stats: {}
};

function normalizeState(s){
  return {
    waiting: Array.isArray(s.waiting) ? s.waiting : [],
    incourt: Array.isArray(s.incourt) ? s.incourt : [],
    maxInCourt: (s.maxInCourt === undefined ? null : s.maxInCourt),
    stats: (typeof s.stats === 'object' && s.stats !== null ? s.stats : {})
  };
}

let initialized = false;

/* ---- Initial load ---- */
stateRef.once("value").then(snap=>{
  if(snap.exists()) state = normalizeState(snap.val());
  else stateRef.set(state);

  initialized = true;
  updatePlayerSelect();
  render();
});

/* ---- Realtime sync ---- */
stateRef.on("value", snap=>{
  if(!initialized) return;
  if(snap.exists()){
    state = normalizeState(snap.val());
    updatePlayerSelect();
    render();
  }
});

/* ---- Save ---- */
function save(){
  stateRef.set(state).then(()=>{
    console.log("‚úÖ Firebase saved");
    updatePlayerSelect();
  }).catch(e=>console.error("‚ùå Firebase error:", e));
}

/* ---- UI Logic ---- */
function setLimit(){
  const val = parseInt(document.getElementById('maxInCourt').value);
  if(!isNaN(val) && val>0){
    state.maxInCourt = val;
    save();
  }
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

function updatePlayerSelect(){
  const select = document.getElementById('playerSelect');
  select.innerHTML = '';
  Object.keys(state.stats).forEach(name=>{
    const option = document.createElement('option');
    option.value = name;
    option.innerText = name;
    select.appendChild(option);
  });
}

function addSelectedOrNewPlayers(){
  const select = document.getElementById('playerSelect');
  const selected = Array.from(select.selectedOptions).map(opt => opt.value);

  const input = document.getElementById('nameInput');
  const rawNames = input.value.split(',').map(n=>n.trim()).filter(n=>n.length>0);

  const allNames = [...new Set([...selected,...rawNames])];

  allNames.forEach(n=>{
    const inWaiting = state.waiting.includes(n);
    const inCourt = state.incourt.some(p=>p.name===n);
    if(inWaiting || inCourt){ showToast(`${n} already exists`); return; }

    state.waiting.push(n);
    if(!state.stats[n]) state.stats[n] = 0;
  });

  input.value='';
  save();
  render();
  showToast(`${allNames.length} players processed`);
}

function clearCourt(){
  const allPlayers = [...state.waiting,...state.incourt.map(p=>p.name)];
  state.waiting = [];
  state.incourt = [];
  Object.keys(state.stats).forEach(name => state.stats[name]=0);

  save();
  render();
  showToast(`Cleared ${allPlayers.length} players and reset stats`);
}

function render(){
  const waitingDiv = document.getElementById('waitingList');
  const incourtDiv = document.getElementById('inCourtList');

  waitingDiv.innerHTML='';
  incourtDiv.innerHTML='';

  const prioritizedWaiting = getPrioritizedWaitingList();
  const availableSlots = (state.maxInCourt === null)
    ? Infinity
    : state.maxInCourt - state.incourt.length;
  
    prioritizedWaiting.forEach((name,i)=>{

    const div=document.createElement('div');
    div.className='item';

    const arrow=document.createElement('div');
    arrow.className='icon-btn btn-move';
    arrow.innerHTML = '<span class="material-icons">arrow_forward</span>';
    
    if(i >= availableSlots){
      arrow.classList.add('icon-disabled');
    }
      
    arrow.onclick = () => moveToInCourtByName(name);

    const games=state.stats[name]||0;
    div.innerHTML=`<span>${name}<span class="stats">(games: ${games})</span></span>`;
    div.appendChild(arrow);
    waitingDiv.appendChild(div);
  });

  state.incourt.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='item incourt';

    const actions=document.createElement('div');
    actions.className='actions';

    const stay=document.createElement('div');
    stay.className='icon-btn btn-stay';
    stay.innerHTML = '<span class="material-icons">refresh</span>';
    if(p.extraUsed) stay.classList.add('icon-disabled');
    stay.onclick=()=>stayOneMore(i);

    const back=document.createElement('div');
    back.className='icon-btn btn-back';
    back.innerHTML = '<span class="material-icons">arrow_back</span>';
    back.onclick=()=>moveToWaiting(i);

    actions.appendChild(stay);
    actions.appendChild(back);

    div.innerHTML=`<span>${p.name}</span>`;
    div.appendChild(actions);
    incourtDiv.appendChild(div);
  });
}

function addToWaitingList(){ addSelectedOrNewPlayers(); }

function getPrioritizedWaitingList() {
  const indexed = state.waiting.map((name, index) => ({
    name,
    games: state.stats[name] || 0,
    index // FIFO index
  }));

  indexed.sort((a, b) => {
    if (a.games !== b.games) {
      return a.games - b.games; // least games first
    }
    return a.index - b.index;   // FIFO within same games
  });

  return indexed.map(p => p.name);
}

function moveToInCourt(index){
  if(index!==0) return;
  if(state.maxInCourt!==null && state.incourt.length>=state.maxInCourt) return;

  const prioritized = getPrioritizedWaitingList();
  const name = prioritized[0];
  
  // remove that name from real FIFO list
  const idx = state.waiting.indexOf(name);
state.waiting.splice(idx, 1);
  state.stats[name]=(state.stats[name]||0)+1;
  state.incourt.push({name:name,extraUsed:false});
  save();
}

function moveToInCourtByName(name){
  if(state.maxInCourt!==null && state.incourt.length>=state.maxInCourt) return;

  const idx = state.waiting.indexOf(name);
  if(idx === -1) return;

  state.waiting.splice(idx,1);
  state.stats[name]=(state.stats[name]||0)+1;
  state.incourt.push({name:name,extraUsed:false});
  save();
}
function stayOneMore(i){
  const p=state.incourt[i];
  if(p.extraUsed) return;

  p.extraUsed=true;
  state.stats[p.name]=(state.stats[p.name]||0)+1;
  save();
}

function moveToWaiting(i){
  const p=state.incourt.splice(i,1)[0];
  state.waiting.push(p.name);
  save();
}
</script>

</body>
</html>
