<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DBN Games Manager</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body{font-family:Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px}
h2{text-align:center}

/* ---------- NAV ---------- */
.nav{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-bottom:20px;
}
.nav button{
  background:#263238;
}
.nav button.active{
  background:#1976d2;
}

/* ---------- CONTROLS ---------- */
.controls,.limit-controls{
  max-width:900px;
  margin:15px auto;
  display:flex;
  gap:10px
}

input,select{
  flex:1;padding:10px;border-radius:6px;border:1px solid #ccc
}

button{
  padding:10px 15px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#1976d2;
  color:white;
  font-weight:bold
}

button:hover{background:#125aa0}

.container{
  display:flex;
  gap:20px;
  max-width:900px;
  margin:auto
}

.panel{
  flex:1;
  background:white;
  padding:15px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1)
}

.panel h3{text-align:center;margin-top:0}

.list{
  min-height:300px;
  border:2px dashed #ccc;
  border-radius:8px;
  padding:10px
}

.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#e3f2fd;
  margin:10px 0;
  padding:14px 16px;
  border-radius:8px;
  font-size:20px;
  font-weight:600;
}

.item.incourt{background:#c8e6c9}

.icon-btn{
  width:64px;height:64px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:32px;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
}

.btn-move{background:#4caf50;color:white}
.btn-back{background:#f44336;color:white}
.btn-stay{background:#ff9800;color:white}

.icon-disabled{
  background:#bdbdbd !important;
  cursor:not-allowed;
  opacity:.5;
  pointer-events:none;
}

.actions{display:flex;gap:14px}

/* ---------- TEAM PAGE ---------- */
#teamPage{display:none}

.team-controls{
  max-width:900px;
  margin:auto;
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.team-box{
  background:white;
  padding:15px;
  border-radius:10px;
  margin:10px auto;
  max-width:900px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.team{
  border:1px solid #ccc;
  border-radius:8px;
  padding:10px;
  margin:10px 0;
}

.match{
  background:#e8f5e9;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>üè∏ DBN Games Manager</h2>

<div class="nav">
  <button id="btnQueue" class="active" onclick="showPage('queue')">Queue Manager</button>
  <button id="btnTeam" onclick="showPage('team')">Team Generator</button>
</div>

<!-- ================= QUEUE PAGE ================= -->
<div id="queuePage">

<div class="limit-controls">
<input type="number" id="maxInCourt" placeholder="Max in-court players" min="1" />
<button onclick="setLimit()">Set Limit</button>
</div>

<div class="controls">
<select id="playerSelect" multiple></select>
<input type="text" id="nameInput" placeholder="Enter new names (comma separated)" />
<button onclick="addSelectedOrNewPlayers()">Add Players</button>
<button onclick="clearCourt()">Clear Court</button>
</div>

<div class="container">
<div class="panel">
<h3>‚è≥ Waiting List</h3>
<div id="waitingList" class="list"></div>
</div>

<div class="panel">
<h3>üèüÔ∏è In-Court List</h3>
<div id="inCourtList" class="list"></div>
</div>
</div>

</div>

<!-- ================= TEAM PAGE ================= -->
<div id="teamPage">

<div class="team-controls">
<select id="teamSize">
  <option value="2">Team Size 2</option>
  <option value="3">Team Size 3</option>
  <option value="4">Team Size 4</option>
</select>

<button onclick="generateTeams()">Generate Teams</button>
<button onclick="reshuffleTeams()">üîÅ Reshuffle</button>
<button onclick="generateMatches()">Generate Matches</button>
</div>

<div id="teamsContainer" class="team-box"></div>
<div id="matchesContainer" class="team-box"></div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
firebase.initializeApp(window.FIREBASE_CONFIG);
const db = firebase.database();
const stateRef = db.ref("fifoState");
</script>

<script>
let state={
  waiting:[],
  incourt:[],
  maxInCourt:null,
  stats:{} // name -> {games, skill, gender, history}
};

let initialized=false;

/* ---------- NAV ---------- */
function showPage(p){
  document.getElementById('queuePage').style.display = p==='queue'?'block':'none';
  document.getElementById('teamPage').style.display = p==='team'?'block':'none';
  document.getElementById('btnQueue').classList.toggle('active',p==='queue');
  document.getElementById('btnTeam').classList.toggle('active',p==='team');
}

function normalizeState(s){
  return {
    waiting: Array.isArray(s.waiting) ? s.waiting : [],
    incourt: Array.isArray(s.incourt) ? s.incourt : [],
    maxInCourt: (s.maxInCourt === undefined ? null : s.maxInCourt),
    stats: (typeof s.stats === 'object' && s.stats !== null ? s.stats : {})
  };
}

/* ---------- INIT ---------- */
stateRef.once("value").then(snap=>{
  if(snap.exists()) state = normalizeState(snap.val());
  else stateRef.set(state);
  initialized=true;
  updatePlayerSelect();
  render();
});

stateRef.on("value",snap=>{
  if(!initialized) return;
  if(snap.exists()){
    state = normalizeState(snap.val());
    updatePlayerSelect();
    render();
  }
});

function save(){ stateRef.set(state); }

/* ---------- QUEUE LOGIC (UNCHANGED CORE) ---------- */

function setLimit(){
  const v=parseInt(maxInCourt.value);
  if(v>0){ state.maxInCourt=v; save(); }
}

function updatePlayerSelect(){
  playerSelect.innerHTML='';
  Object.keys(state.stats).forEach(n=>{
    const o=document.createElement('option');
    o.value=n;o.innerText=n;
    playerSelect.appendChild(o);
  });
}

function addSelectedOrNewPlayers(){
  if(!Array.isArray(state.waiting)) state.waiting=[];
  if(!Array.isArray(state.incourt)) state.incourt=[];
  if(!state.stats) state.stats={};

  const selected=[...playerSelect.selectedOptions].map(o=>o.value);
  const raw=nameInput.value.split(',').map(n=>n.trim()).filter(Boolean);
  const all=[...new Set([...selected,...raw])];

  all.forEach(n=>{
    if(!state.stats[n]){
      state.stats[n]={games:0,skill:3,gender:"M",history:{with:{},against:{}}};
    }

    const inWaiting = state.waiting.includes(n);
    const inCourt = state.incourt.find(p=>p.name===n);

    if(!inWaiting && !inCourt){
      state.waiting.push(n);
    }
  });

  nameInput.value='';
  save();
}

function clearCourt(){
  state.waiting=[];
  state.incourt=[];
  Object.values(state.stats).forEach(p=>p.games=0);
  save();
}

function render(){
  waitingList.innerHTML='';
  inCourtList.innerHTML='';

  const prioritized=getPrioritizedWaitingList();
  const slots = state.maxInCourt? state.maxInCourt-state.incourt.length : 999;

  prioritized.forEach((n,i)=>{
    const d=document.createElement('div');d.className='item';
    const b=document.createElement('div');
    b.className='icon-btn btn-move';
    if(i>=slots) b.classList.add('icon-disabled');
    b.innerHTML='<span class="material-icons">arrow_forward</span>';
    b.onclick=()=>moveToInCourtByName(n);
    d.innerHTML=`<span>${n} (games:${state.stats[n].games})</span>`;
    d.appendChild(b);
    waitingList.appendChild(d);
  });

  state.incourt.forEach((p,i)=>{
    const d=document.createElement('div'); 
    d.className='item incourt';
  
    const a=document.createElement('div'); 
    a.className='actions';
  
    /* ---- STAY BUTTON ---- */
    const stay=document.createElement('div');
    stay.className='icon-btn btn-stay';
    stay.innerHTML='<span class="material-icons">refresh</span>';
  
    if(p.extraUsed) stay.classList.add('icon-disabled');
  
    stay.onclick=()=>stayOneMore(i);
  
    /* ---- BACK BUTTON ---- */
    const back=document.createElement('div');
    back.className='icon-btn btn-back';
    back.innerHTML='<span class="material-icons">arrow_back</span>';
    back.onclick=()=>moveToWaiting(i);
  
    a.appendChild(stay);
    a.appendChild(back);
  
    d.innerHTML=`<span>${p.name}</span>`;
    d.appendChild(a);
    inCourtList.appendChild(d);
  });

}

function getPrioritizedWaitingList(){
  return state.waiting
    .map((n,i)=>({n,g:state.stats[n].games,i}))
    .sort((a,b)=>a.g-b.g||a.i-b.i)
    .map(x=>x.n);
}

function moveToInCourtByName(name){
  if(state.maxInCourt && state.incourt.length>=state.maxInCourt) return;
  const i=state.waiting.indexOf(name);
  if(i===-1) return;
  state.waiting.splice(i,1);
  state.stats[name].games++;
  state.incourt.push({name, extraUsed:false});
  save();
}

function moveToWaiting(i){
  const p=state.incourt.splice(i,1)[0];
  state.waiting.push(p.name);
  save();
}

function stayOneMore(i){
  const p = state.incourt[i];
  if(p.extraUsed) return;

  p.extraUsed = true;
  state.stats[p.name].games++;
  save();
}


/* ================= TEAM GENERATOR ================= */

let currentTeams=[];

function getPlayersForTeams(){
  return Object.keys(state.stats).map(n=>({
    name:n,
    skill:state.stats[n].skill||3,
    gender:state.stats[n].gender||"M"
  }));
}

function generateTeams(){
  const size=parseInt(teamSize.value);
  const players=getPlayersForTeams();
  const numTeams=Math.floor(players.length/size);
  if(numTeams<1) return;

  players.sort((a,b)=>b.skill-a.skill);

  let teams=[...Array(numTeams)].map(()=>[]);
  let dir=1,idx=0;

  players.forEach(p=>{
    teams[idx].push(p);
    if(dir===1){
      if(idx===numTeams-1) dir=-1; else idx++;
    }else{
      if(idx===0) dir=1; else idx--;
    }
  });

  spreadFemales(teams);
  currentTeams=teams;
  renderTeams();
}

function spreadFemales(teams){
  const females=[];
  teams.forEach(t=>t.forEach(p=>p.gender==="F"&&females.push(p)));

  if(females.length>=teams.length*2) return;

  teams.forEach(t=>{
    const f=t.filter(p=>p.gender==="F");
    if(f.length>1){
      for(let i=1;i<f.length;i++){
        const target=teams.find(x=>x.filter(p=>p.gender==="F").length===0);
        if(target){
          target.push(f[i]);
          t.splice(t.indexOf(f[i]),1);
        }
      }
    }
  });
}

function reshuffleTeams(){
  const size=parseInt(teamSize.value);
  let players=getPlayersForTeams().sort(()=>Math.random()-0.5);
  const numTeams=Math.floor(players.length/size);
  let teams=[...Array(numTeams)].map(()=>[]);
  players.forEach((p,i)=>teams[i%numTeams].push(p));
  spreadFemales(teams);
  currentTeams=teams;
  renderTeams();
}

function renderTeams(){
  teamsContainer.innerHTML='';
  currentTeams.forEach((t,i)=>{
    const sum=t.reduce((a,b)=>a+b.skill,0);
    const d=document.createElement('div');
    d.className='team';
    d.innerHTML=`<b>Team ${i+1} (Skill Sum: ${sum})</b><br>`+
      t.map(p=>`${p.name} (${p.skill}${p.gender==="F"?"F":""})`).join('<br>');
    teamsContainer.appendChild(d);
  });
}

function generateMatches(){
  matchesContainer.innerHTML='';
  for(let i=0;i<currentTeams.length;i+=2){
    if(currentTeams[i+1]){
      const d=document.createElement('div');
      d.className='match';
      d.innerText=`Team ${i+1} vs Team ${i+2}`;
      matchesContainer.appendChild(d);
    }
  }
}
</script>

</body>
</html>
